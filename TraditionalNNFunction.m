function [Y,Xf,Af] = myNeuralNetworkFunction(X,~,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Auto-generated by MATLAB, 01-Apr-2021 19:13:11.
%
% [Y] = myNeuralNetworkFunction(X,~,~) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 6xQ matrix, input #1 at timestep ts.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 4xQ matrix, output #1 at timestep ts.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [2;3.05;0;0.002;0.025;5.5];
x1_step1.gain = [0.0246305418719212;0.0476758045292014;0.0455580865603645;20.8333333333333;1.1142061281337;0.689655172413793];
x1_step1.ymin = -1;

% Layer 1
b1 = [-2.4921397893807415436;2.4158190623775004369;2.3746588374184076642;2.1905759706438394652;-1.8881718685951243142;-1.9265613166378268151;-1.8750376179336469828;-1.79506398660447819;-1.9719893852620018482;1.3878860379899953248;1.2669362918040798505;1.2659818923425816273;1.0106909288008445458;-1.0193552024333694117;0.74212080296639182375;-0.6021857630312952292;0.67008809462462415318;0.34517517874756004082;-0.28452558825538620813;0.050755378555634167448;-0.045273095520821024507;-0.20731980517476983339;0.44564414847964434196;-0.4556107098823730106;0.53571187931627073375;-0.928225505841708598;0.90331364100782807203;-0.89637306380945680484;-1.167518618450342105;-1.4052184772418518932;1.3639571282268128094;-1.5310939884467302807;-1.5511973213419429918;1.8583164327835826057;1.765172518667308621;-2.0278008271679839325;2.263488308737696908;2.2815443206062919757;-2.456701709968835079;2.6715066009748533737];
IW1_1 = [1.0402645614192811419 -0.27408749417467259679 -1.6196876673311209061 -0.6936061981034612467 1.4697224816756049304 0.73812059587029432706;-0.81705880900362037877 -1.3540360085919702637 0.1236063509932625315 1.353546130119622326 -1.549889477611608779 -0.20600758422815323989;-1.7155298935177072384 0.34796068128318136115 0.51596220195953612642 1.3866406639076076512 0.89855474143621805183 0.5901027584614896293;-1.3171272155854489849 1.2061104783052922773 -0.41938903432872898236 1.2601820998677575325 0.93610629171994841347 -1.1219145812454029976;1.2798233349783010304 -1.8036459004536555817 0.57113219192390318746 -0.61208075161950348253 1.2523130822453969468 0.15017067239931050637;0.79445555179672822099 1.4980829158787407618 0.97971415653831972481 1.1290198959732220541 -1.1570121400592465744 0.49779809093414084664;1.2552063475016228544 0.27755550626286451532 0.29497456562555296466 -1.2433504135538626656 -0.15643802195814801581 -1.8041146775273646519;0.39496236186778677091 -0.28646746823525981451 0.73576043053814743633 0.68345138700131158327 -2.2304644650692644348 -0.27852781774078150256;1.0916152727739625306 -0.96330947015029899649 -0.42899282428448570759 1.0335432774067678796 -0.29970616661457577523 1.3683947524731554513;-1.3169563893886866435 -0.70621132732008951027 0.95936497425241928916 -1.1583667294999013819 -1.0127433453517959983 -1.0836622082422302515;-1.5629638378797658937 -0.88518756754958138888 -1.245496212540006864 0.5160932762605684454 -0.8384052572569088424 -0.97276132701247342016;-1.3033170877785804631 0.009538188292473659402 0.42782824820238246621 1.8580027075549043758 0.2476296077078128377 0.79825230008361180989;-0.26166980135890893777 -0.71021038067697472851 1.5042564735644852192 -1.1305752601613276997 1.3355152544189610175 -0.90858849474237346477;1.242159908136765134 1.1005467950557488166 -0.59641316998168492081 -0.82046092230092870778 -0.16009217688188204232 1.670655420123608792;-1.0477857350162982364 1.5996428368439197243 -0.51156242421811015664 1.4346985850400488793 0.10067555437851438693 0.81082864170956392424;0.44836895130794007791 1.0498791055993299537 0.25708840577352659595 -0.015685050250642044306 1.9074587793712141082 -1.3146244243079967529;-1.6103947624018315476 -0.43549700489870135645 -0.27455959906102767043 -1.3885615756947136124 1.2918176837179982108 0.31790921452945236636;-1.1696357170147728688 0.36670433898763898917 -1.5562894701139944331 -0.98881972691072905768 0.14341232163016770507 1.369279476879799784;1.4219901916046957524 0.64789999146439058997 1.0449087776735135336 0.73431098086129020786 1.6314794882360019734 0.22813386441274535743;-0.9664261708139814111 -1.1180766956182934813 -1.3363430120772095133 0.21401590648111859516 -1.4154573563617094401 0.74742215198243078245;1.2358905557890416116 0.044041097697669936983 -0.23285662781539656629 -0.79218083048661502854 1.3081755591714299136 1.6127216678696736363;-0.6605275870571069019 -0.7573281320984638354 -1.7817440257061047948 0.48642608089173472452 -0.54349522051310061865 1.3947268229894804747;0.74137970249540330325 0.25791352180451354581 1.7570664046485797716 0.71161537733771373926 -1.0548373931783197044 -1.1539543898955217927;-1.4532539082861695157 1.4373367413224953371 0.095272992938135445118 -0.71369450779366938598 1.0501483889098375268 -0.96862140759767012543;0.94048232751635774118 -0.26713556361186707733 1.7899937760767299366 -0.33297155606268069583 -0.56455217805038571122 -1.4520191531565478371;-0.024226443390288905644 -1.4731027523418469549 -0.30671930187738388751 -0.33092470508201388135 -1.1821253966021123549 -1.660937437358214197;1.2254540973080458865 1.0046842257180017555 0.77267013073861656736 0.67631583957593566225 -1.1795453866300082968 -1.2517982287919062756;-0.759493239329985248 1.2244222941092779422 -0.98675153695771811169 -1.2945896363162123777 1.4549224849946063021 0.24356346639241965857;-0.46022140667138966563 -0.55913352799611903965 1.6151777400730360501 1.6566650715812869521 0.74915581524519370138 0.46775918758449369639;-1.0082269283840414875 -0.71994186438451879262 1.1234048668801996929 -0.53091182439101203272 1.2445749001787140831 1.0702134853669165171;1.5567287312086401929 0.95132892624778742086 -0.48951160670261817387 -0.013019432299568846345 1.5751283133090565602 0.66717785105490678976;-0.41908811398199691256 0.074710263528747572481 0.77879576778196091258 1.7702468527355759154 1.1189394934463905429 -1.2377286220294283492;-1.7716097972854307763 0.18307782170161276958 0.20399586069464364924 0.63775583974665461806 1.883410986859859193 -0.035401507927920912444;0.81150171802575732372 0.61623425430573264272 1.3713156725282338311 -1.3618751726960498516 -0.90691058282745551367 -0.96235905611798200354;0.2325069546068798676 -1.4080145863106960924 -1.1147164547533807699 0.84820353273863857702 1.5473624925759559279 0.92928609372071202532;-0.57300939824023211511 0.98450390681374022606 -1.4063905586219498378 -1.0673232742418763408 0.99985839920987196194 -1.1422244396589571469;0.91752799890447889197 1.2747914965294737666 1.0316232253576873568 1.3340443672742168246 -0.66431569892748854045 0.65823015885512492495;1.0040629011926138769 -1.1619934807172600522 -0.7932489403137558126 1.1720774980798993603 -1.2598109274042503802 0.92648872734234766213;-1.0560538144004403271 1.459262395840097648 -1.0707769191085483307 0.064942960100049518246 1.0711235197774136019 1.0717390225286984595;0.080418121794842215011 1.5675999580656885257 0.49852238153703504198 0.65391696917704111858 -1.6688482414598631021 -0.62099689582966555168];

% Layer 2
b2 = [-0.31421952700709210315;-0.607239844914921445;0.3507604358086795493;-0.083018340293644091177];
LW2_1 = [0.012950454334540967977 0.50512180348596180668 -0.61734341468144871001 0.38614884980649610835 -0.24248503311773805802 0.6839599673938426827 -0.82399817149175780262 -0.29578630253856796894 -0.49307980080918800692 -0.24503170484354194758 0.70331772045711615782 0.35291505739260148333 -0.19343862529036923159 -0.35989814310353723803 -0.42855696796084979949 0.066815237219789574974 -0.79889319521118706824 0.3147394851851547104 0.47212989444123365512 -0.50392719567526622626 0.011456761539382723583 -0.27418599360355128125 -1.1060672950918164492 -0.94822069855953050599 -0.46667608742316007975 1.1129601350577289498 0.66752290224251908946 0.17279797756541853682 0.47380994257926123403 0.18612075421713222823 0.33139481037233364802 0.784126225351839512 -0.94370972320001367262 0.73566751032300614632 0.98235975710818956852 0.43422648512749367766 -0.1652155246546354872 0.97132496615324459555 0.40683463896570926099 -0.21324951539284231483;-0.0012624746208168705422 -0.43405096840203349906 -0.34322313837797480129 -0.84680591254328008155 0.90418559329282499615 0.31635377369261574731 0.95769556425583846071 -0.91611423395201230235 -0.70803142221141612822 0.60624176517822048194 0.44224457194793420634 -0.02809449973673568135 -0.75199446619437448902 0.087577179987676750939 -0.84902871221023024084 0.49902074801481555166 0.767308503510725326 -0.44708739438092698348 -0.84990931147551096458 -0.871883987354799328 -0.17595362295951591514 0.68400429784830774071 0.23088567994763323221 -0.40693818571207029944 -0.15283113209448645486 -0.60157784611165154853 -0.51187791790980319284 -0.75687696359494738285 0.58215454095375662735 -0.17217642312932743276 -0.32159296282795379884 -0.63685425718999622013 0.99101344716716321948 0.70656384648093362166 0.88846838962295371367 -0.58758403242219825469 -0.20218531724104521485 -0.023365439472324289055 -1.0083313242519367225 0.26805778215814463072;-0.75940839378959079653 0.80477018156799473569 -0.27025194448979483752 0.27586621823333690173 -0.47786779775041793306 0.16714438392127214938 -0.1682990264986677087 0.15855444271242868925 0.40952575252355338797 0.8183686145402165879 0.19246194786539458366 0.22650847354146680379 0.045714323675343219999 0.28699048947233035678 -0.22038858644943842835 1.0846924693382218319 -0.5804580849243742291 -1.0214336288829819477 -0.15741305031905236667 0.23334873274885628569 -0.045740993566823942573 0.43712892264926289654 -0.74209861352196815343 -0.25202429160089756532 -0.0037949332291203887943 0.42088805046283306321 -0.76000427161692840627 -0.74645583891160538492 -0.65669749996433723904 -0.42372005694807152176 -0.56172101956485331886 -0.62622962907151291656 -0.41767168660807751923 -0.047036260570810332904 -0.80114430358539723276 0.57742857170104011644 -0.69477753213923665321 -0.59822912931416694082 0.89853435179261142984 -0.38119946225784095972;0.68623950610070338918 -0.66278595506614890187 -0.48384085559024875289 -0.40634460645731551587 -0.97400811089134342602 0.07987962541459878163 0.20262260486368785517 -0.035805355813081710115 -0.84410681480358773499 0.13762946190050265316 0.30466198023014340324 0.53418866101086048825 0.02022858134851118414 0.11954520874553549448 0.053019514753641958094 0.89391327934653708187 0.97008320724011043446 -0.43107813996461902262 -0.71133019675501740764 -0.84023383387128747213 0.091550442003966697735 0.89625220018446172254 -0.87373553044788776489 -0.27351410534087061688 0.018901770993008451538 0.35172593564120235854 -0.0274794304007838254 0.34419087857938995834 0.49578592615231892315 -0.25411588440841192948 0.026108222785215542266 0.32952914891108814333 0.26358350780048800388 0.39783905168050609502 0.085079172184075346763 -0.02087512103293062346 -0.48429767817628666116 0.49044076623764393252 0.64621854534863920616 0.76530231992585506795];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX
    X = {X};
end

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = softmax_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Output 1
    Y{1,ts} = a2;
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX
    Y = cell2mat(Y);
end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Competitive Soft Transfer Function
function a = softmax_apply(n,~)
if isa(n,'gpuArray')
    a = iSoftmaxApplyGPU(n);
else
    a = iSoftmaxApplyCPU(n);
end
end
function a = iSoftmaxApplyCPU(n)
nmax = max(n,[],1);
n = bsxfun(@minus,n,nmax);
numerator = exp(n);
denominator = sum(numerator,1);
denominator(denominator == 0) = 1;
a = bsxfun(@rdivide,numerator,denominator);
end
function a = iSoftmaxApplyGPU(n)
nmax = max(n,[],1);
numerator = arrayfun(@iSoftmaxApplyGPUHelper1,n,nmax);
denominator = sum(numerator,1);
a = arrayfun(@iSoftmaxApplyGPUHelper2,numerator,denominator);
end
function numerator = iSoftmaxApplyGPUHelper1(n,nmax)
numerator = exp(n - nmax);
end
function a = iSoftmaxApplyGPUHelper2(numerator,denominator)
if (denominator == 0)
    a = numerator;
else
    a = numerator ./ denominator;
end
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end
